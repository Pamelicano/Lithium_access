<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Register User</title>
    <link rel="stylesheet" type="text/css" href="commandline.css">
    <script src="https://cdn.jsdelivr.net/npm/web3/dist/web3.min.js"></script>
    <script src="translation2.js" defer></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const currentLang = localStorage.getItem('lang') || 'en';
            langToggle.checked = currentLang == 'kk';

            langToggle.addEventListener('change', () => {
                const newLang = langToggle.checked ? 'kk' : 'en';
                if (typeof changeLang == 'function') {
                    changeLang(newLang);
                } else console.error('Function changeLang is not founded.');
            });
        });
    </script>
</head>
<body>
    <header class="header">
        <h1 id = "reg">Register User</h1>
        <button onclick="window.location.href='index.html'" id = "back">  Back </button>
        <label class="lang-switch">
            <input type="checkbox" id="langToggle">
            <span class="slider"></span>
        </label>
    </header>
    <div class="container">
        <div class="left-section">
            <form id="regur">
                <div class="input-box">
                    <input type="text" id="userAddress" required placeholder=" ">
                    <label id = "label1">User Address</label>
                </div>
                <div class="input-box">
                    <select id="userRole" required>
                        <option value="" disabled selected id = "choose">Choose Role</option>
                        <option value="0" id = "ow">Owner</option>
                        <option value="1" id = "ad">Admin</option>
                        <option value="2" id = "us">User</option>
                    </select>
                </div>
                <button type="submit" class="bth" id="registerUser">Submit</button>
            </form>
        </div>
        <div class="right-section">
            <div class="top-right">
                <p id = "text">Text</p>
            </div>
            <div class="bottom-right" id="terminal">
                <pre id="terminal-output"></pre>
            </div>
        </div>
    </div>
    <script>
        const contractAddress = '0x5FbDB2315678afecb367f032d93F642f64180aa3';
        const inputbox = document.getElementById('regur');
        inputbox.addEventListener('submit', async(e) => {
            e.preventDefault();
            const userAddress = document.getElementById('userAddress').value.trim();
            const userRole = parseInt(document.getElementById('userRole').value.trim(), 10);
            const roleBigInt = BigInt(userRole); 

            const sender = localStorage.getItem('userAddress');
            try {
                console.log('Attempting to connect to the blockchain...');
                const web3 = new Web3('http://127.0.0.1:8545/');
                console.log('Web3 initialized:', web3);

                const response = await fetch('http://127.0.0.1:8080/artifacts/contracts/Lock.sol/AccessControlList.json');
                const contractData = await response.json();

                console.log('Contract data loaded: ', contractData);
                if (!contractData || !contractData.abi) {
                    console.error('ABI not found in contract data');
                    alert('Contract ABI missing');
                    return;
                }
                const contract = new web3.eth.Contract(contractData.abi, contractAddress);
                console.log('Contract initialized:', contract);

                const receipt = await contract.methods
                .registerUser(userAddress, roleBigInt) 
                .send({ from: sender, gas: 3000000 });

                console.log('Registration transaction receipt:', receipt);
                if (userRole == 0) {
                    alert(`User role successfully assign to Owner!`);
                } else if (userRole == 1) {
                    alert(`User role successfully assign to Admin!`);
                } else {
                    alert(`User role successfully assign to User!`);
                }
            } catch(error) {
                console.error('Error during user registration:', error);
                alert('Failed to register user. Check the console for details.');
            }
        });
    </script>
</body>
</html>
